# 系统设计文档

## 1. 文档概述
- **1.1 编写目的**
  - 将《需求文档》中定义的业务目标转化为可实施的技术方案，指导平台的架构设计与研发工作。
  - 为各技术团队（前端、后端、测试、运维、产品）提供统一的参考标准，便于协作与评审。
  - 在项目生命周期内作为变更与优化的依据，记录关键技术决策与假设。
- **1.2 项目范围与上下文**
  - 项目范围：建设一套面向公路局及管养单位的在线培训、考试与证书管理 SaaS 平台，覆盖平台运营方、主管单位管理员、管养单位管理员、工程师学员等角色。
  - 业务上下文：平台需支持多租户、课程与考试管理、资料审核、证书签发、数据报表等核心流程，并符合政府监管与行业规范。
  - 技术上下文：系统需部署在公司指定云环境，支持横向扩展、租户隔离、安全合规要求。
- **1.3 参考资料**
  - 《需求文档》
  - 公司架构与编码规范、DevOps 流程文档
  - 行业政策与监管要求（如交通运输部培训规范、数据安全法规）
  - 现有类似项目的最佳实践与经验总结

## 2. 总体架构设计
- **2.1 系统总体架构图（文字描述）**
  - **客户端层**：Web 前端（PC/H5）、移动端小程序/APP，负责与用户交互，通过 HTTPS 与后端通信；支持缓存控制、离线提示。
  - **接入层**：API 网关/负载均衡进行流量调度、统一鉴权、限流；CDN 分发静态资源与视频课件；WAF 防护外部攻击。
  - **应用层**：
    - **身份与权限服务**：登录、单点登录、租户隔离、权限校验。
    - **课程服务**：课程、课件、题库、测验管理。
    - **培训计划服务**：计划配置、规则、任务分配、版本记录。
    - **学员与资料服务**：学员档案、资料审核流程、岗位映射。
    - **考试与监考服务**：考试安排、试卷生成、答题收集、监考异常识别、成绩处理。
    - **证书与资质服务**：证书模板、签发、停用、到期提醒。
    - **通知消息服务**：站内信、短信、邮件、推送统一调度与状态跟踪。
    - **报表与分析服务**：数据聚合、统计、导出、API 输出。
    - **配置中心/字典服务**：补考规则、提醒频率、字典项、租户配置。
  - **数据层**：
    - 关系型数据库（如 MySQL）存储核心业务数据；按租户/业务划分库表，建立索引、审计字段。
    - 缓存（Redis）用于会话、热点数据、消息队列辅助状态。
    - 对象存储（OSS/OBS/S3）存放课件、视频、证书文件，并结合 CDN 加速；支持防盗链。
    - 日志与审计数据集中存储在日志服务（如 ELK/Grafana Loki）中。
  - **集成层**：与短信/邮件网关、政府监管平台、证书验证系统、企业 HR 系统等通过 API、消息队列或批量导入导出交互。
  - **运维支撑**：CI/CD 流水线、监控告警、配置中心、服务注册发现、灰度发布工具、审计平台。
- **2.2 部署架构与环境规划**
  - **环境划分**
    - 开发环境（DEV）：供研发自测使用，可使用共享数据库与服务，支持热更新与调试。
    - 测试环境（TEST）：用于功能、集成与回归测试；数据初始化与生产接近，禁止开发直接改动。
    - 预发布环境（STAGING/UAT）：与生产环境配置一致，用于验收和灰度演练；通过自动化部署同步生产配置。
    - 生产环境（PROD）：正式对外提供服务，启用严格的安全、监控与备份策略。
  - **基础设施规划**
    - 容器化部署（Kubernetes/云容器服务），每个环境独立命名空间；核心服务按模块划分 Deployment，Replica 数按负载设定。
    - 使用云负载均衡（如 ALB/ELB）分发前端与后端流量；结合 API 网关进行鉴权、限流、协议转换。
    - 前端静态资源存放于对象存储/静态站点并接入 CDN；课件与视频通过点播服务或对象存储 + CDN 加速。
  - **网络与安全**
    - 各环境部署于独立 VPC/子网，生产环境与测试环境网络隔离。
    - 核心服务仅开放必要端口，数据库、缓存、对象存储通过安全组/ACL 控制访问；开启跨可用区部署提升容错。
    - 接入 WAF、防火墙与入侵检测，配合 VPN/零信任方案供内部运维访问。
  - **数据与存储**
    - 数据库采用主从或多 AZ 部署，高可用架构；定期快照备份，备份跨地域存放。
    - 缓存服务采用双节点或集群模式，确保高可用；对象存储开启版本管理与生命周期策略。
  - **发布与灰度**
    - CI/CD 管道按“DEV → TEST → STAGING → PROD”推进，自动化构建与单元测试通过后才能进入下一阶段。
    - 生产环境采用滚动更新/蓝绿发布，关键服务上线前在预发布环境完成回归；支持按租户或流量比例进行灰度。
  - **运维支持**
    - 配置中心统一管理环境变量与敏感配置，采用动态下发；日志统一收集到日志平台。
    - 监控平台针对各环境配置不同阈值与告警策略，生产环境告警通过短信/IM 实时通知。
  - **部署拓扑说明（文字版）**
    - DMZ 层：WAF → 负载均衡（L7）→ API 网关；静态资源通过 CDN → 对象存储。
    - 应用层：容器集群中的多个微服务 Pod（课程、计划、考试、证书、通知、认证等），旁路部署 Sidecar（如 Service Mesh）用于流量治理、链路追踪。
    - 数据层：数据库主从节点、Redis 集群、对象存储、日志/监控系统，部署于内网安全区，仅通过堡垒机或专线访问。
    - 运维层：CI/CD 平台、配置中心、监控告警、日志分析系统部署在独立运维子网，通过 VPN/零信任访问。
  - **云资源映射建议**
    - 计算：云服务器/容器服务（如 EKS/AKS/ACK），按服务类型设置独立节点池（前端渲染服务、核心业务服务、批任务）。
    - 网络：云负载均衡（ALB/NLB）、API 网关、VPC、子网、安全组、NAT 网关。
    - 存储：关系型数据库服务（RDS）、分布式缓存（Redis/Memcached）、对象存储（OSS/S3）、块存储（用于日志/备份）。
    - 安全：WAF、DDoS 防护、云防火墙、堡垒机、密钥管理服务（KMS）。
    - 运维：日志服务（ELK/Cloud Logging）、监控（Prometheus + Grafana/云监控）、CI/CD（Jenkins/GitLab CI/Cloud Build）、配置中心（Nacos/Consul/Apollo）。
- **2.3 多租户与隔离策略**
  - **数据隔离**：所有核心业务表均通过租户 ID（tenant_id）区分数据；敏感数据采用租户独立加密密钥（KMS）保护。
  - **配置隔离**：租户可配置品牌、域名、课程模板等信息，存储在配置中心并按租户加载；支持租户级功能开关与套餐限额。
  - **资源配额**：按租户定义课程数、学员数、并发任务等配额；监控配额使用情况，接近阈值时自动预警。
  - **权限隔离**：管理员登录后仅能访问所属租户数据；平台超级管理员通过独立后台管理租户生命周期。
  - **性能隔离**：缓存与队列使用租户维度的命名空间；关键服务支持按租户限流，防止单租户异常影响整体平台。

- **2.4 核心后端实现策略（更新）**
  - 采用 **模块化单体（Modular Monolith）** 架构，使用 NestJS 作为主框架。各业务领域封装为独立模块，保持清晰依赖关系，未来可平滑拆分为微服务。
  - 主要业务模块：
    1. `auth`：身份认证、角色切换、Token 管理与租户隔离。
    2. `tenant`：租户信息、套餐、品牌配置。
    3. `user-profile`：人员档案、资质、审核流程。
    4. `org-structure`：单位组织树、班组/项目视图、岗位映射。
    5. `course`：课程、课件、题库、测验。
    6. `training-plan`：培训计划、任务分配、规则与版本管理。
    7. `learning-progress`：学习记录、学时统计、异常预警。
    8. `exam`：考试场次、报名、答卷、成绩、补考流程。
    9. `certificate`：证书模板、签发记录、续期提醒。
    10. `notification`：消息模板、站内信/短信/邮件、状态跟踪。
    11. `reporting`：仪表盘统计、报表快照、导出。
    12. `file`：统一文件上传、对象存储对接。
    13. `system-config`：字典、功能开关、全局参数。
  - 横切模块：日志、监控、异常过滤器、事件总线、审计记录等封装在 `libs/` 目录，供各业务模块复用。
  - 模块交互原则：尽量通过服务接口或领域事件交流，避免跨模块直接访问数据库实体，降低耦合。

## 3. 技术栈与选型
- **3.1 前端技术**
  - 框架：React 18 + TypeScript，结合 Vite 作为构建工具，提升启动与热更新效率。
  - 组件库：Ant Design + Ant Design Pro 布局方案，满足企业级表单、表格、流程页面需求，支持主题定制、暗色模式。
  - 可视化：AntV G2Plot（或 ECharts）用于仪表盘、统计图表；配合 Ant Design 的图表封装组件。
  - 状态管理：Redux Toolkit 或 Recoil，结合 React Query/SWR 做数据请求与缓存管理。
  - 路由与权限：React Router v6 + 自定义权限路由守卫。
  - 移动端：采用响应式 H5 与小程序（Taro/UniApp）方案，无需独立原生 App；共享 React 组件逻辑，通过封装适配层输出。
- **3.2 后端技术**
  - **代码组织**：
    - `apps/core`: NestJS 主应用，负责引导、配置与 HTTP 接口。
    - `libs/commons`: 公共类型、响应包装、异常定义、工具函数。
    - `libs/entities`: Prisma/TypeORM 实体定义与数据库访问层。
    - `libs/events`: 领域事件定义与发布/订阅封装。
    - 每个业务模块位于 `apps/core/src/modules/{domain}`，内部再划分 `controller/service/repository`。
  - **模块通信**：通过 NestJS 的事件发布 (`EventEmitter2`) 或队列（Bull/Redis）传递领域事件，如 `training_plan.published`、`learning.assignment.completed` 等。
  - 框架候选：
    - **NestJS（Node.js + TypeScript）**：与前端技术同语言体系，支持依赖注入、模块化架构，适合快速开发 RESTful API，生态完善。
    - **FastAPI（Python）**：轻量高效，适合构建 API 服务，内置自动文档；团队若偏 Python，可使用。
  - 建议优先选择 NestJS，理由：与现有 React/TS 团队技能栈一致，降低沟通成本；模块化与装饰器风格利于分层；配套 TypeORM/Prisma 方便管理数据库。
  - 架构模式：初期采用模块化单体（Monolith Modular），按课程、计划、考试、证书、通知等模块划分；预留未来拆分为微服务的边界。
- **3.3 数据存储**
  - 关系型数据库：MySQL 8（云 RDS），满足事务一致性与统计需求；可使用分库分表策略应对租户扩张。
  - 缓存：Redis（云托管版），用于会话、验证码、热点数据、队列辅助。
  - 对象存储：云对象存储（OSS/S3），存放课件、视频、证书文件，结合 CDN。
  - 日志与搜索：初期通过 RDS + 索引实现查询；若需全文搜索，可在后续引入 Elasticsearch。
- **3.4 中间件与基础设施**
  - 消息/任务队列：RabbitMQ 或基于 Redis Stream 的简化方案，用于通知、异步任务、补考安排等。
  - 配置中心：Apollo/Nacos 或云配置服务；初期可采用环境变量+K8s ConfigMap，规模扩大后引入。
  - CI/CD：GitLab CI 或 Jenkins Pipeline；结合容器仓库（Harbor/云镜像仓库）与 Kubernetes 部署。
  - 日志与监控：Prometheus + Grafana/云监控；日志采集采用 ELK 或云日志服务。
- **3.5 选型对比与理由**
  - 前端继续沿用团队熟悉的 React/TS 体系，降低学习成本，同时 Ant Design Pro 对 B 端业务支持成熟。
  - 后端选择 NestJS 保持同语言栈，TypeScript 全栈提高可读性、接口约束一致；若特定模块需数据分析，可引入 Python 微服务与 FastAPI。
  - 基础设施选择云托管服务（RDS、Redis、对象存储、CDN），减少自建运维成本，符合“简单、稳定”的目标。

## 4. 模块设计
- **4.1 前端模块划分**
  - **公共基础模块**
    - `layouts/`：基础布局、顶部导航、侧边栏、面包屑、标签页。
    - `components/`：通用组件库（表格、表单、上传、图表、弹窗等）。
    - `hooks/`：数据请求、权限校验、表单封装、响应式适配。
  - **平台超级管理员（PA）模块**
    - `pa/tenant`：租户列表、详情、开通向导页面（对应页面编码 PA-01-01~03）。
      - 数据结构示例：
        ```json
        {
          "id": "tenant_001",
          "name": "贵州省公路局",
          "industry": "交通运输",
          "region": "贵州贵阳",
          "package": "旗舰版",
          "status": "active",
          "createdAt": "2024-01-15T09:30:00Z",
          "expireAt": "2025-01-14T23:59:59Z",
          "activeUsers7d": 458,
          "contractCode": "HT2024-001",
          "opsOwner": "李工",
          "tags": ["省级", "重点客户"]
        }
        ```
      - API 契约：
        - `GET /api/admin/tenants` 支持分页、过滤、排序，返回字段参考上方结构。
        - `PATCH /api/admin/tenants/{id}/status` 启用/停用租户。
        - `POST /api/admin/tenants/{id}/reset-admin` 重置租户管理员初始密码。
        - `POST /api/admin/tenants/export` 导出当前筛选结果。
    - `pa/resources`：公共课程库、题库、标签管理（PA-02-01~03）。
    - `pa/ops`：版本发布、运行监控、工单中心、运营仪表盘（PA-03-01~PA-04-01）。
  - **主管单位管理员（GA）模块**
    - `ga/dashboard`：主管单位仪表盘（GA-01-01）。
    - `ga/org`：组织结构、岗位体系、人员管理与资料审核工作台（GA-02、GA-05 系列）。
    - `ga/course`：课程列表、编辑、评价（GA-03 系列）。
    - `ga/plan`：培训计划列表、编辑向导、详情（GA-04 系列）。
    - `ga/monitor`：进度看板、预警列表（GA-06 系列）。
    - `ga/exam`：考试列表、场次配置、监考记录、成绩复核（GA-07 系列）。
    - `ga/certificate`：证书模板、发放记录、设置（GA-08 系列）。
    - `ga/report`：报表中心、自定义报表；`ga/system`：权限、日志、配置（GA-09、GA-10 系列）。
  - **管养单位管理员（MA）模块**
    - `ma/dashboard`：单位仪表盘（MA-01 系列）。
       - `ma/org`：组织管理、学员列表、批量导入、资料初审（MA-02 系列）。
    - `ma/plan`：接收计划、执行详情（MA-03 系列）。
    - `ma/progress`：学习进度、异常提醒（MA-04 系列）。
    - `ma/exam`：考试安排、监考记录、异常上报（MA-05 系列）。
    - `ma/feedback`：问题反馈、处理进度（MA-06 系列）。
    - `ma/report`：单位统计报表（MA-07 系列）。
  - **工程师学员（ST）模块**
    - `st/home`：任务总览（ST-01 系列）。
    - `st/course`：课程详情、播放器、测验、讨论（ST-02 系列）。
    - `st/exam`：考试入口、考试说明、作答界面、错题本（ST-03 系列）。
    - `st/certificate`：证书列表、详情（ST-04 系列）。
    - `st/notifications`：消息中心（ST-05 系列）。
    - `st/profile`：个人资料、账号安全、学习档案（ST-06 系列）。
    - `st/audit`：资料提交状态、审核结果、补充入口（ST-07 系列）。
    - `st/mobile`：移动端学习首页、线下签到适配页面（ST-08 系列）。
- **4.2 后端服务划分**
  - **Auth Service**：统一认证、单点登录、权限校验、租户隔离、Token 管理。
  - **Tenant Service**：租户开通、配置、配额、品牌管理，提供租户生命周期 API。
  - **User & Profile Service**：管理员/学员账号、岗位、资料审核流程、角色权限。
  - **Course Service**：课程、课件、题库、测验管理；与对象存储、转码服务集成。
  - **Training Plan Service**：计划创建、规则配置、任务分配、版本管理，关联课程与学员。
  - **Learning Progress Service**：学习任务、进度统计、学时记录。
  - **Exam Service**：考试安排、试卷生成、答题收集、监考异常、成绩判分。
  - **Certificate Service**：证书模板、签发、停用、提醒，与外部证书系统同步。
  - **Notification Service**：消息模板、站内信、短信、邮件、推送队列。
  - **Report & Analytics Service**：计划、考试、证书等数据聚合、报表生成、导出。
  - **Config & Dictionary Service**：补考规则、提醒频率、字典维护、参数配置。
  - 服务间通过 REST API + 消息队列交互，后续可拆分为独立部署单元。
- **4.3 接口设计原则与规范**
  - **通信协议**：统一使用 HTTPS + RESTful API；对于实时消息可引入 WebSocket/Server-Sent Events。
  - **版本管理**：API 路径包含版本号 `/api/v1/...`；重大变更通过新增版本、保留旧版一段时间。
  - **鉴权机制**：采用 JWT + Refresh Token，结合租户 ID；后台管理提供基于角色的权限校验；敏感操作要求二次确认。
  - **请求与响应格式**：JSON；统一响应结构 `{ code, message, data, traceId }`，错误码分为系统、业务两大类。
  - **分页与筛选**：标准参数 `page`, `pageSize`, `filters`, `sort`；支持多条件筛选与导出。
  - **幂等与重试**：POST/PUT 接口需支持幂等 key；对通知发送、考试提交等关键接口加入重试与去重机制。
  - **错误处理**：规范化错误码表（如 1000 成功、2xxx 业务错误、4xxx 参数/权限、5xxx 系统异常），错误信息包含解决建议。
  - **日志与审计**：接口需记录操作人、租户、请求参数、响应结果、耗时；关键操作写入审计日志。
  - **接口文档**：使用 Swagger/OpenAPI 自动生成文档，结合 Postman/Apifox 管理测试用例。
- **4.4 关键接口示例（平台租户中心）**
  - **租户列表数据结构**
    ```json
    {
      "id": "tenant_001",
      "name": "贵州省公路局",
      "industry": "交通运输",
      "region": "贵州贵阳",
      "package": "旗舰版",
      "status": "active",
      "createdAt": "2024-01-15T09:30:00Z",
      "expireAt": "2025-01-14T23:59:59Z",
      "activeUsers7d": 458,
      "contractCode": "HT2024-001",
      "opsOwner": "李工",
      "tags": ["省级", "重点客户"]
    }
    ```
  - **接口契约**
    - `GET /api/admin/tenants`：分页查询租户列表，支持名称、行业、套餐、状态、时间范围等多条件筛选；返回字段参考上方数据结构。
    - `PATCH /api/admin/tenants/{id}/status`：启用/停用租户；请求体包含目标状态与操作说明，需记录审计日志。
    - `POST /api/admin/tenants/{id}/reset-admin`：重置租户管理员初始密码；触发通知邮件或短信。
    - `POST /api/admin/tenants/export`：导出当前筛选条件下的租户清单，生成异步任务并返回下载地址。

## 5. 数据设计
- **5.1 核心数据模型（文字版 ER 描述）**
  - **租户域**
    - `Tenant`（租户）：记录租户基础信息、套餐、品牌。与 `OrgUnit`、`TenantConfig`、`TenantUser` 形成一对多关系。
    - `TenantConfig`：租户级配置项（品牌、域名、功能开关）；与 `Tenant` 一对多。
  - **组织与人员域**
    - `OrgUnit`（组织/单位）：树形结构存储主管单位、管养单位、项目部；字段包含 `parent_id`、`org_type`。一对多关联 `User`, `TrainingAssignment`。
    - `RoleProfile`（岗位/能力模型）：与 `OrgUnit`、`Course`, `TrainingPlan` 多对多关联，通过 `RoleCourse`、`PlanRole` 中间表实现。
    - `User`（账号）：基础身份信息、租户、所属组织、岗位。与 `UserCredential`（登录凭据）、`UserProfile`（个人资料）、`UserRole`（权限）一对一或一对多。
    - `UserProfile`：存储真实姓名、证件、专业履历、资格证附件，支持审核状态字段。
    - `UserAuditLog`：记录资料审核流转（初审、复审、驳回），关联 `UserProfile` 与审核管理员。
  - **课程与资源域**
    - `Course`：课程主表，包含类型、状态、学时、适用岗位。与 `CourseVersion`（多版本）、`CourseSection`（章节）一对多。
    - `CourseAsset`：课件资源（视频、文档），关联对象存储 URL；与 `CourseSection` 一对多。
    - `QuestionBank`、`Question`：题库与题目，题目与课程、知识点关联；`PaperTemplate` 用于考试抽题。
  - **培训计划域**
    - `TrainingPlan`：计划主体，含批次、时间范围、规则。与 `PlanCourse`（必修/选修课程）、`PlanExam`、`PlanTargetRole`、`PlanVersion` 相关联。
    - `TrainingAssignment`：学员在计划中的任务记录（课程/考试/作业），包含状态、进度、学时。
    - `LearningRecord`：细化到课件或章节的学习日志（时长、完成进度、测验得分）。
  - **考试与成绩域**
    - `Exam`：考试主表，关联计划、考核规则。
    - `ExamSession`：具体场次，含时间、监考方式；与 `ExamRegistration`（报名/出勤）、`ExamPaper`（生成的试卷）关联。
    - `ExamAnswerSheet`：学员答题结果；`ExamProctorLog` 记录监考与异常。
    - `ScoreRecord`：考试/作业成绩汇总，包含复核状态。
    - `RetakeTask`：补考安排，与考试和学员关联。
  - **证书与资质域**
    - `CertificateTemplate`：模板、签章、有效期设置。
    - `CertificateInstance`：个人证书，关联学员、计划、成绩；包含状态（待签发/生效/停用）。
  - **通知与运维域**
    - `NotificationTemplate`、`NotificationTask`、`NotificationLog`：模板配置、发送任务、发送结果。
    - `ReportSnapshot`：定期生成的报表数据快照，关联计划、组织维度。
    - `AuditLog`：系统操作审计；`SystemConfig`：全局配置项。
  - **实体关系概览（文字 ER 图）**
    - `Tenant` (1) ── (N) `OrgUnit`
    - `Tenant` (1) ── (N) `TenantConfig`
    - `OrgUnit` (1) ── (N) `User`
    - `User` (1) ── (1) `UserProfile`
    - `UserProfile` (1) ── (N) `UserAuditLog`
    - `RoleProfile` (N) ── (N) `Course` （中间表 `role_course`）
    - `RoleProfile` (N) ── (N) `TrainingPlan` （中间表 `plan_target_role`）
    - `Course` (1) ── (N) `CourseVersion`
    - `CourseVersion` (1) ── (N) `CourseSection`
    - `CourseSection` (1) ── (N) `CourseAsset`
    - `TrainingPlan` (1) ── (N) `PlanCourse`
    - `TrainingPlan` (1) ── (N) `TrainingAssignment`
    - `TrainingAssignment` (1) ── (N) `LearningRecord`
    - `TrainingPlan` (1) ── (N) `Exam`
    - `Exam` (1) ── (N) `ExamSession`
    - `ExamSession` (1) ── (N) `ExamRegistration`
    - `ExamRegistration` (1) ── (1) `ExamAnswerSheet`
    - `Exam` / `ExamSession` (1) ── (N) `ScoreRecord`
    - `TrainingPlan` (1) ── (N) `CertificateInstance`
    - `CertificateTemplate` (1) ── (N) `CertificateInstance`
    - `NotificationTemplate` (1) ── (N) `NotificationTask`
    - `NotificationTask` (1) ── (N) `NotificationLog`
    - 共性关系：所有业务实体均通过 `tenant_id` 与 `Tenant` 关联，实现租户隔离。
  - **Mermaid ER 图示例**
    ```
    erDiagram
      Tenant ||--o{ OrgUnit : "has"
      Tenant ||--o{ TenantConfig : "configures"
      OrgUnit ||--o{ User : "contains"
      User ||--|| UserProfile : "owns"
      UserProfile ||--o{ UserAuditLog : "history"
      RoleProfile }o--o{ Course : "suitable_for"
      RoleProfile }o--o{ TrainingPlan : "target_of"
      Course ||--o{ CourseVersion : "versions"
      CourseVersion ||--o{ CourseSection : "includes"
      CourseSection ||--o{ CourseAsset : "uses"
      TrainingPlan ||--o{ PlanCourse : "binds"
      TrainingPlan ||--o{ TrainingAssignment : "assigns"
      TrainingAssignment ||--o{ LearningRecord : "records"
      TrainingPlan ||--o{ Exam : "requires"
      Exam ||--o{ ExamSession : "has"
      ExamSession ||--o{ ExamRegistration : "enrolls"
      ExamRegistration ||--|| ExamAnswerSheet : "submits"
      Exam ||--o{ ScoreRecord : "produces"
      ExamSession ||--o{ ScoreRecord : "produces"
      TrainingPlan ||--o{ CertificateInstance : "issues"
      CertificateTemplate ||--o{ CertificateInstance : "instantiates"
      NotificationTemplate ||--o{ NotificationTask : "schedules"
      NotificationTask ||--o{ NotificationLog : "logs"
    ```

- **5.2 数据库表结构（核心表概览）**
    | `user_qualification` | `id`, `user_id`, `name`, `license_no`, `level`, `issue_at`, `expire_at`, `status`, `attachments_json`, `review_status` | 索引：`idx_qualification_user_status` |
    | `notification_user_status` | `id`, `notification_id`, `user_id`, `tenant_id`, `read_flag`, `read_at` | 支持快速查询未读消息 |
  - **命名规范**：使用小写下划线命名，如 `tenant`, `user_profile`；所有表包含 `id`, `tenant_id`, `created_at`, `updated_at`, `created_by`, `updated_by`, `is_deleted`（软删除）。
  - **关键表字段示例**：

    | 表名 | 主要字段 | 索引与备注 |
    | --- | --- | --- |
    | `tenant` | `id`, `code`, `name`, `industry`, `status`, `package_level`, `expire_at` | 索引：`uk_tenant_code`, `idx_tenant_status` |
    | `tenant_config` | `id`, `tenant_id`, `config_key`, `config_value`, `scope` | 索引：`idx_config_tenant_key` |
    | `org_unit` | `id`, `tenant_id`, `parent_id`, `name`, `org_type`, `region_code`, `path` | 索引：`idx_org_parent`, `idx_org_path`；`path` 保存层级路径 |
    | `role_profile` | `id`, `tenant_id`, `name`, `category`, `level`, `description` | 与课程/计划通过关联表连接 |
    | `user` | `id`, `tenant_id`, `login_name`, `email`, `mobile`, `status`, `org_id`, `role_profile_id` | 唯一索引：`uk_user_login`, 普通索引：`idx_user_org` |
    | `user_profile` | `id`, `user_id`, `real_name`, `id_card`, `profession`, `resume`, `cert_files`, `audit_status` | 索引：`idx_profile_audit_status` |
    | `user_audit_log` | `id`, `user_profile_id`, `step`, `status`, `comment`, `auditor_id`, `handled_at` | 按 `user_profile_id`、`handled_at` 建索引 |
    | `course` | `id`, `tenant_id`, `code`, `name`, `course_type`, `status`, `credits`, `hours`, `difficulty`, `tags` | 索引：`idx_course_tenant_status`, `idx_course_tags` (FTS) |
    | `course_version` | `id`, `course_id`, `version_no`, `change_log`, `status`, `published_at` | 索引：`uk_course_version` |
    | `course_section` | `id`, `course_version_id`, `title`, `seq`, `content_type`, `asset_id`, `duration` | 索引：`idx_section_course` |
    | `course_asset` | `id`, `tenant_id`, `file_name`, `file_type`, `storage_url`, `duration`, `size`, `status` | 索引：`idx_asset_tenant_type` |
    | `question_bank` | `id`, `tenant_id`, `name`, `category`, `description` | |
    | `question` | `id`, `bank_id`, `question_type`, `difficulty`, `stem`, `options`, `answer`, `analysis`, `tags` | 索引：`idx_question_bank_type`, 支持全文索引 |
    | `training_plan` | `id`, `tenant_id`, `code`, `name`, `plan_type`, `start_at`, `end_at`, `deadline`, `status`, `approval_status` | 索引：`idx_plan_tenant_status`, `idx_plan_time` |
    | `plan_course` | `id`, `plan_id`, `course_id`, `is_required`, `order_no`, `credit_requirement` | 联合唯一 `uk_plan_course` |
    | `plan_target_role` | `id`, `plan_id`, `role_profile_id`, `org_scope`, `custom_rules` | |
    | `training_assignment` | `id`, `plan_id`, `user_id`, `org_id`, `task_type`, `task_id`, `status`, `progress`, `last_progress_at` | 索引：`idx_assignment_user`, `idx_assignment_status` |
    | `learning_record` | `id`, `assignment_id`, `course_section_id`, `learn_minutes`, `completion_rate`, `quiz_score`, `last_view_at` | 索引：`idx_record_assignment` |
    | `exam` | `id`, `plan_id`, `name`, `mode`, `total_score`, `pass_score`, `max_retake`, `cooldown_days`, `status` | 索引：`idx_exam_plan` |
    | `exam_session` | `id`, `exam_id`, `start_at`, `end_at`, `monitor_type`, `location`, `status` | 索引：`idx_session_exam`, `idx_session_time` |
    | `exam_registration` | `id`, `session_id`, `user_id`, `org_id`, `status`, `checkin_status`, `score`, `exception_flag` | 索引：`idx_registration_user`, `idx_registration_status` |
    | `exam_answer_sheet` | `id`, `registration_id`, `paper_id`, `answers_json`, `score`, `auto_score`, `manual_score`, `submitted_at` | |
    | `score_record` | `id`, `user_id`, `plan_id`, `task_type`, `task_id`, `score`, `result`, `review_status`, `reviewer_id` | 索引：`idx_score_user`, `idx_score_plan` |
    | `certificate_template` | `id`, `tenant_id`, `name`, `valid_months`, `issuer`, `design_config`, `auto_issue_rule` | |
    | `certificate_instance` | `id`, `user_id`, `template_id`, `plan_id`, `issue_at`, `expire_at`, `status`, `revoke_reason` | 索引：`idx_certificate_user`, `idx_certificate_status` |
    | `notification_template` | `id`, `tenant_id`, `notice_type`, `channel`, `content`, `variables` | 唯一约束：`uk_template_type_channel` |
    | `notification_task` | `id`, `tenant_id`, `template_id`, `target_type`, `target_scope`, `schedule_at`, `status` | 索引：`idx_task_status`, `idx_task_schedule` |
    | `notification_log` | `id`, `task_id`, `user_id`, `channel`, `send_status`, `sent_at`, `response` | 索引：`idx_log_user_channel` |
    | `report_snapshot` | `id`, `tenant_id`, `report_type`, `stat_scope`, `period_start`, `period_end`, `file_url`, `status` | |
    | `audit_log` | `id`, `tenant_id`, `user_id`, `action`, `resource_type`, `resource_id`, `payload`, `created_at` | 按 `tenant_id`、`action`、时间建索引，支持归档 |
    | `system_config` | `id`, `config_key`, `config_value`, `scope`, `description` | |

  - **索引与分区策略**
    - 针对高频写入的 `learning_record`, `exam_answer_sheet`, `notification_log` 采用按日期或租户的分区表。
    - `report_snapshot`、`audit_log` 支持按月份分表，便于归档。
    - 所有外键通过逻辑约束（应用层校验），数据库中以索引 + `tenant_id` 判断，避免跨租户访问。

- **5.3 数据生命周期**
  - 课程、计划、考试等主数据长期保存；学习记录、考试答卷保存 ≥ 48 个月，超过期限可归档至冷存储。
  - 审核日志、操作审计满足监管要求保留 ≥ 360 天；证书信息与关联记录保留至证书失效后至少 48 个月。
  - 通知日志、系统日志按 180 天滚动清理，并在清理前转储至对象存储。
  - 提供数据导出与销毁流程，满足租户退出时的数据取回与删除需求。

## 6. 安全与权限设计
- **6.1 认证机制**
  - **登录与会话**：采用账号密码 + 租户编码登录，支持短信/邮箱二次验证；生成 JWT Access Token + Refresh Token，Token 中携带 `tenant_id`、`roles`。
  - **单点登录（SSO）**：支持与主管单位或平台方的统一身份系统对接，优先采用 SAML2.0 / OIDC；租户级别可配置是否启用。
  - **凭证安全**：密码使用 Bcrypt/Scrypt 加密存储；支持密码复杂度策略、定期强制修改、登录失败锁定机制。
  - **设备与会话管理**：支持查看与终止当前登录会话；限制同账号多地点异常登录触发预警。
- **6.2 授权模型**
  - **RBAC + ABAC 组合**：基础权限由角色驱动（平台超级管理员、主管单位管理员、管养单位管理员、学员等）；对敏感数据追加属性控制，如所属组织、岗位、租户。
  - **权限粒度**：分为菜单访问、操作权限（增删改查）、数据权限（按组织/岗位/租户范围）。支持自定义角色，绑定权限模板。
  - **租户隔离**：所有接口校验 `tenant_id`，禁止跨租户访问；平台运营后台通过独立域名和权限集访问。
  - **审批链权限**：资料审核、计划审批等流程需记录审批节点与权限校验，防止越权操作。
  - **操作日志**：对关键操作（计划发布、考试复核、证书签发、账号冻结）记录操作者、时间、变更内容、来源 IP。
- **6.3 数据安全**
  - **传输安全**：全站启用 HTTPS/TLS1.2+；客户端与对象存储交互采用签名 URL；防止中间人攻击。
  - **存储加密**：数据库敏感字段（身份证号、联系方式、证书编号）使用列级加密或应用层加密；对象存储开启服务端加密、访问控制列表。
  - **数据脱敏**：前端展示时对敏感信息（身份证、手机号、证书编号）做部分脱敏；导出报表需依据角色权限控制。
  - **访问控制**：数据库、缓存、对象存储等仅开放白名单访问；后台管理操作通过 VPN 或零信任访问。
  - **安全审计**：定期进行安全扫描、漏洞修复；部署 WAF、入侵检测（IDS/IPS）；对异常行为（频繁登录失败、批量导出）触发告警。
- **6.4 防护策略**
  - **接口防护**：关键接口引入限流、验证码；防止暴力破解、爬虫、恶意请求。
  - **考试防作弊**：支持人脸识别/随机抽题、切屏检测、设备指纹；监考日志作为审计依据。
  - **课程资源防盗链**：CDN + Token 鉴权 + 水印；播放地址设置有效期，防止外链传播。
  - **备份与恢复**：定期执行数据备份，并进行恢复演练（至少每季度一次）；备份文件加密存储，访问受控。
- **6.5 安全管理流程**
  - 建立安全事件响应流程：发现异常 → 通知安全负责人 → 分析处理 → 记录复盘。
  - 对新功能上线前进行安全评估，确保满足数据安全与合规要求。
  - 制定租户退出时的数据销毁流程，确保数据不可恢复。

## 7. 集成与接口
- **7.1 外部系统对接**
  - **短信/邮件/推送网关**：与第三方通知渠道（如阿里云短信、企业邮件服务）集成，通过 `Notification Service` 统一调度；需支持模板变量、签名、发送状态回调。
  - **政务监管平台接口**：根据主管单位要求，将培训计划、考试成绩、证书发放等数据按周期推送至监管平台；采用安全 API（HTTPS+证书）或文件批量上传，记录回执。
  - **证书验证/人事系统**：与主管单位已有证书系统或人事档案系统对接，提供证书签发、停用、查询接口；支持通过 API 或 SFTP 批量交互。
  - **单点登录/身份平台**：支持对接企业级 SSO（SAML/OIDC/CAS），提供租户配置入口；兼容第三方身份认证（如企业微信、钉钉账号）。
  - **视频转码/点播服务**：与云转码或点播服务集成，课程视频上传后触发转码回调，更新 `CourseAsset` 状态。
  - **对象存储/CDN**：采用云存储（OSS/S3）与 CDN 服务，权限控制通过预签名 URL + Token。
  - **发票/支付（可选）**：若平台涉及增值服务，可对接第三方支付、电子发票系统；当前阶段可暂不实现。

- **7.2 内部接口契约**
  - **服务间 API**：按模块划分 RESTful API，统一前缀 `/api/v1/{module}`；内部服务之间可通过 API 网关或服务调用框架（如 gRPC/NestJS Microservices）。
  - **通用响应规格**：所有 API 返回 `code`, `message`, `data`, `traceId`；错误码参照 `接口设计原则`。
  - **分页与过滤**：统一采用 `page`, `pageSize`, `filters`, `sort` 参数；复用前端表格组件。
  - **接口文档**：采用 Swagger/OpenAPI3 + Apifox/Postman 管理，生成 SDK/Mock；接口更新需同步文档和变更记录。
  - **调用频率限制**：在 API 网关配置限流策略（如每租户/QPS 限制），防止恶意调用。

- **7.3 模块接口映射（与需求文档对齐）**
  - **租户管理（PA-01 系列）**：`Tenant Service` 提供租户 CRUD、套餐配置、品牌设置 API；`Auth Service` 支持管理员创建与重置。
  - **资源库（PA-02 系列）**：`Course Service` 提供公共课程审核、题库维护 API。
  - **版本运维（PA-03~04）**：`Ops Service` 或统一后台接口提供版本发布、监控数据；与 CI/CD、监控平台对接。
  - **组织与岗位管理（GA-02 系列）**：`User & Profile Service`、`Org Service` 提供组织树、岗位、资料审核接口；返回的数据需要带权限过滤。
  - **课程与计划（GA-03~04 系列）**：`Course Service`、`Training Plan Service` 提供计划创建、课程绑定、规则配置 API；`Learning Progress Service` 返回进度数据。
  - **人员任务与资料审核（GA-05 系列）**：`User & Profile Service` 提供资料审核、审核日志 API；`Training Plan Service` 提供任务匹配、差异化配置接口。
  - **学习监控（GA-06）**：`Learning Progress Service`、`Report Service` 返回计划进度、预警数据。
  - **考试、证书（GA-07~08）**：`Exam Service` 提供考试管理、场次、监考、成绩复核 API；`Certificate Service` 提供模板配置、签发、停用接口。
  - **单位执行（MA 系列）**：`Plan Service`、`Learning Progress Service` 提供计划接收、执行详情接口；`Exam Service` 提供监考记录、异常上报接口。
  - **学员端（ST 系列）**：`Learning Progress Service`、`Course Service`、`Exam Service`、`Certificate Service`, `Notification Service` 提供任务列表、学习记录、考试、证书、消息等 API；移动端接口同一套。

- **7.4 导入导出与集成流程**
  - 提供统一的导入引擎：支持 Excel/CSV 模板下载、字段校验、错误定位、异步处理；常见场景包括学员批量导入、组织结构导入、题库导入。
  - 导出流程：支持生成 Excel/PDF 报表，采用异步任务+通知提醒；文件存储在对象存储，设置有效期。
  - 对接外部系统时，提供安全认证（Token、IP 白名单），记录调用日志，限制调用频率；错误回执需明确并能重试。
  - 对于定时同步（如证书上报、监管报送），使用调度任务 + API 交互/文件传输，确保失败重试与人工干预入口。

## 8. 性能与容量规划
- **8.1 性能目标**
  - 页面加载：关键业务页面（计划详情、考试列表）首屏渲染时间 ≤ 3 秒；课程播放启动延迟 ≤ 2 秒。
  - 接口响应：90% 接口响应时间 ≤ 500 ms，99% ≤ 1,500 ms；批量导出、报表生成等异步任务提示进度。
  - 并发承载：单租户同时在线学员 1,000 人时系统保持稳定；全平台并发峰值 50,000，平均 CPU 利用率 ≤ 60%。
  - 考试场景：支持 5,000 名学员同时进行在线考试，答题请求响应 ≤ 1 秒，提交成功率 100%。
  - 通知发送：通知队列每分钟处理 ≥ 5,000 条，失败重试机制保证最终送达。
- **8.2 容量估算**
  - 数据量预估：每年新增课程 2,000 个、培训计划 5,000 个、学员 100,000 人，考试答题记录 10,000,000 条；通过冷热数据分层存储减少主库压力。
  - 存储需求：课程视频平均 500 MB，课件 100 MB；按 1000 门课程估算对象存储需求约 500 TB（含备份）；数据库主库初期预留 500 GB，按年扩容。
  - 缓存容量：Redis 集群初始配置 4 节点，每节点 8 GB 内存，存储会话、热点数据；根据租户扩展增加节点。
  - 网络带宽：课程视频依赖 CDN，回源带宽控制在 200 Mbps 内；API 服务保留 1 Gbps 内网带宽，按压测结果调整。
- **8.3 压测计划**
  - 工具与环境：采用 JMeter/K6、Locust 在专用压测环境执行；压测环境与生产等配置，避免影响实际服务。
  - 场景覆盖：
    - 高并发登录、资料审核、课程学习浏览。
    - 集中考试答题提交、成绩判分、补考生成。
    - 报表导出、通知批量发送等后台任务。
  - 指标监控：接口响应时间、错误率、资源利用率、数据库 QPS、Redis 命中率。
  - 验收标准：达到性能目标且无严重错误；发现瓶颈需优化并重新压测。
- **8.4 扩展策略**
  - 应用层：Kubernetes 支持水平扩展，按租户或业务模块调整副本数；使用 HPA 根据 CPU/QPS 自动扩容。
  - 数据库：读写分离、分库分表（按租户或业务），热点表添加缓存；定期归档历史数据。
  - 缓存与队列：Redis 集群支持分片扩容；通知队列采用多消费者提高吞吐。
  - 静态资源：CDN 多节点缓存，避免源站压力；视频转码与播放独立服务或 SaaS。
  - 异步化：报表、通知、补考排程等耗时操作采用异步任务；对重型查询提供离线结果或分页加载。
- **8.5 监控与容量管理**
  - 指标采集：Prometheus 采集应用、数据库、缓存、队列指标；Grafana/云监控展示仪表盘。
  - 容量预警：设置 CPU、内存、磁盘、QPS 等阈值；达到 70% 启动扩容计划。
  - 定期评估：每季度审视数据增长、访问趋势，调整资源配置和扩展策略。

## 9. 运维与监控
- **日志体系**
  - 应用日志：结构化输出，包含 `traceId`、`tenant_id`、操作人；通过 Fluent Bit/Logstash 汇聚到 ELK 或云日志服务。
  - 审计日志：关键操作写入审计专用索引，支持查询与导出，满足监管要求。
  - 前端埋点：记录页面访问、接口错误，帮助追踪体验问题。
- **监控与告警**
  - 应用指标：请求量、响应时间、错误率；数据库 QPS、慢查询；Redis 命中率。
  - 业务指标：学习完成率、考试通过率、通知发送成功率；异常事件数量。
  - 告警策略：多渠道（短信/IM/邮件），分重大级别响应；提供值班表与升级流程。
- **灾备与故障处理**
  - 数据备份：数据库每日增量、每周全量；对象存储与配置中心定期备份。
  - 容灾演练：每季度模拟故障切换、恢复流程；记录演练结果与改进项。
  - 故障应急：建立标准故障处理流程（识别→通报→诊断→恢复→复盘），记录时间线。

## 10. 开发流程与质量保障
- **流程规范**
  - 采用 GitFlow/Trunk-based 结合：主干 `main`、开发 `develop`、功能分支 `feature/*`；提交合并需通过代码评审。
  - CI/CD：Push → 自动化构建 → 单元测试 → 代码扫描 → 部署至 DEV/TEST → 人工审批上线。
  - Issue 管理：使用 Jira/禅道等记录需求、缺陷、任务，关联代码提交。
- **代码质量**
  - 前端：ESLint + Prettier + Stylelint；后端：ESLint（TS）、pylint（Python）；统一 commit message 规范。
  - 代码审查：Pull Request 必须至少一人审核；关注安全、性能、可维护性。
  - 静态检查：SonarQube/云代码质量服务，检测重复代码、复杂度、漏洞。
- **测试策略**
  - 单元测试：前后端覆盖率目标 ≥ 60%；关键模块（考试、证书）重点覆盖。
  - 集成测试：跨服务功能、接口契约验证；使用 Postman/Newman 或 Cypress。
  - 端到端测试：核心流程（资料审核→学习→考试→证书）通过自动化脚本验证。
  - 回归与验收：每次发布前进行回归；预发布环境进行业务验收测试（UAT）。

## 11. 风险评估与应对
- **主要风险**
  - 技术风险：全新功能模块复杂度高、数据模型不完善、视频/考试性能瓶颈。
  - 集成风险：与监管平台、SSO 对接接口不稳定、政策变化导致需求调整。
  - 安全与合规：资料审核涉及敏感信息，若防护不足可能造成泄露。
  - 运营风险：租户上线初期培训不足、用户体验不佳导致使用率低。
- **应对措施**
  - 技术预研：关键模块提前做 PoC，制定性能优化预案；数据库结构评审避免重构。
  - 集成预案：与外部系统明确接口规范与 SLA；提供离线备份方案。
  - 安全评估：上线前进行渗透测试与安全加固；敏感数据加密与访问审计。
  - 培训与支持：提供文档、线上培训、客服支持；采集反馈快速迭代。

## 12. 里程碑与计划（示例）
- 阶段划分
  - M1：需求确认 & 概要设计（第 1-2 周）
  - M2：详细设计 & 原型评审（第 3-4 周）
  - M3：开发迭代（第 5-12 周，分 2-3 个迭代）
  - M4：集成测试 & 性能压测（第 13-14 周）
  - M5：预发布 & 用户验收（第 15 周）
  - M6：正式上线 & 运维交接（第 16 周）
- 每个阶段产出：设计文档、实现代码、测试报告、验收总结；明确负责人与质量检查点。

## 附录
- **A. 术语与缩写表**
- **B. 页面编码与模块映射**
- **C. 工具与文档参考链接**

